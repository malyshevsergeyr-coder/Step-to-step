# История интервью и логика проекта

## Интервью (сводка требований)
- Доступ основан на таблице `users`, колонка `role`, роли могут быть множественными (через запятую).
- Админский кабинет доступен пользователю с ролью **Администратор**.
- Начальник определяется по роли **Начальник**, уведомления о новых заявках должны приходить ему в веб‑интерфейсе, с историей и возможностью удаления.
- Три меню заявок: «Задание на раскрой1/2/3», все используют одинаковую форму.
- Поля формы (все обязательны, названия по-русски):
  - Маркер изделия (id_product)
  - Направление (Восполнение/Резка)
  - Следующий процесс (Сборка/Закалка/Обработка/Дабл/Триплекс)
  - Ширина (мм)
  - Высота (мм)
  - Количество изделий
  - Формула
  - Печать (Да/Нет)
  - Стикер (Да/Нет)
  - В ручную (Да/Нет)
  - Припуск (мм)
- Числовые значения сохраняются с двумя знаками после запятой.
- Статусы заявок обязательны: Создана, В работе, Выполнена, Брак, Приостановлена.
- Чат: личные сообщения, индикаторы непрочитанных, фильтр пользователей (сначала онлайн, потом оффлайн), поиск по имени, отображение роли в рамке под именем, цвета рамки (зелёный/серый), поддержка фотографий (до 10 МБ), хранение в Google Drive.
- UI: минимализм, премиальный стиль, анимации при вводе/наведении, центрированные формы.

## Принятая архитектура таблиц
- `cutting_orders` — хранение заявок на раскрой с логированием меню и статуса.
- `notifications` — уведомления начальнику (история + возможность удаления).
- `chat_messages` — личные сообщения и фото.

## Логика обработки данных
1. Авторизация по логину/паролю из `users`, сессия хранится в `sessions`.
2. Роль проверяется по `role` (список через запятую).
3. Администратор видит кабинет заявок, начальник видит меню начальника и уведомления.
4. Создание заявки пишет запись в `cutting_orders` и создает уведомление в `notifications` для пользователей с ролью «Начальник».
5. Чат хранится в `chat_messages`, непрочитанные считаются по пустому `read_at`.
6. Статус онлайн вычисляется по `sessions.last_seen_at` (активность за последние 5 минут).

## Полный лог изменений
### Сервер (Code.gs)
- Добавлены константы листов: `cutting_orders`, `notifications`, `chat_messages`.
- Добавлена загрузка/создание листов и их заголовков.
- Добавлена роль‑проверка `hasRole_()` и проверка сессии `requireSession_()`.
- Реализованы API:
  - `apiCreateCuttingOrder` (валидация, запись заявки, уведомление начальнику).
  - `apiGetNotifications`, `apiDeleteNotification`.
  - `apiGetChatUsers`, `apiGetChatThread`, `apiSendChatMessage`, `apiMarkChatRead`, `apiGetChatUnreadCount`.
- Добавлены утилиты: `notifyBosses_`, `threadKey_`, `formatNumber_`, `getOrCreateFolder_`.
- Чат‑файлы до 10 МБ сохраняются в папке Drive `chat_uploads`.

### Клиент (Index.html)
- Добавлен кабинет администратора с меню из 3 задач и формой.
- Валидация всех полей, кнопка отправки активна только при заполнении.
- Добавлен экран уведомлений для начальника (список + удаление).
- Добавлен чат‑виджет с:
  - индикатором непрочитанных,
  - сортировкой пользователей (онлайн/оффлайн),
  - поиском по имени,
  - отображением роли в рамке (цвет по статусу),
  - отправкой текстов и фото.

## Список ключевых переменных и параметров
- `SHEET_CUTTING_ORDERS = 'cutting_orders'`
- `SHEET_NOTIFICATIONS = 'notifications'`
- `SHEET_CHAT_MESSAGES = 'chat_messages'`
- `CHAT_UPLOADS_FOLDER = 'chat_uploads'`
- `CHAT_MAX_FILE_SIZE = 10 * 1024 * 1024`
- Онлайн‑порог: 5 минут

## Примечания по UX
- Формы в минималистичном, премиальном стиле.
- Уведомления и чат открываются в пределах интерфейса.
