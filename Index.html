<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      body { font-family: "Segoe UI", Arial, sans-serif; margin: 0; background:#f2f3f7; color:#111; }
      .wrap { max-width: 1100px; margin: 24px auto; padding: 16px; }
      .card { background:#fff; border-radius: 18px; padding: 20px; box-shadow: 0 12px 30px rgba(15,17,26,.08); border:1px solid #eceef3; }
      h1 { font-size: 18px; margin: 0 0 12px; }
      .muted { color:#666; font-size: 12px; margin-bottom: 12px; }
      label { display:block; font-size: 12px; color:#333; margin-top: 10px; }
      input, select, textarea { width:100%; padding: 11px 12px; font-size: 14px; border:1px solid #d7dbe4; border-radius: 12px; outline:none; transition: all .2s ease; background:#fff; }
      textarea { min-height: 80px; resize: vertical; }
      input:focus, select:focus, textarea:focus { border-color:#5c6bff; box-shadow: 0 0 0 3px rgba(92,107,255,.12); }
      .row { display:flex; gap:10px; margin-top: 12px; flex-wrap: wrap; }
      button { flex:1; padding: 11px 12px; font-size: 14px; border:0; border-radius: 12px; cursor:pointer; transition: all .2s ease; }
      .primary { background:#111; color:#fff; }
      .primary:disabled { background:#b9bcc6; cursor:not-allowed; }
      .ghost { background:#f1f2f6; }
      .pill { display:inline-block; padding: 6px 10px; border-radius: 999px; background:#eee; font-size: 12px; }
      .err { color:#b00020; font-size: 13px; margin-top: 10px; }
      .ok { color:#0a7a28; font-size: 13px; margin-top: 10px; }
      .top { display:flex; justify-content:space-between; align-items:center; margin-bottom: 10px; }
      .kv { font-size: 13px; margin-top: 8px; }
      .kv b { display:inline-block; min-width: 90px; }
      .menu { display:flex; flex-direction: column; gap: 10px; margin-top: 12px; }
      .menu button { width: 100%; text-align: left; }
      .section-title { font-size: 13px; font-weight: 600; margin: 14px 0 6px; }
      .staff-list { list-style: none; padding: 0; margin: 0; }
      .staff-item { padding: 10px 0; border-bottom: 1px solid #eee; font-size: 13px; }
      .staff-item:last-child { border-bottom: 0; }
      .staff-meta { color: #666; font-size: 12px; margin-top: 4px; }
      .grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 14px; }
      .field-note { font-size: 11px; color:#777; margin-top: 4px; }
      .tab-pill { display:inline-flex; align-items:center; gap:8px; padding: 8px 12px; border-radius: 999px; background:#f0f1f6; border:1px solid transparent; cursor:pointer; font-size: 13px; }
      .tab-pill.active { background:#111; color:#fff; }
      .admin-layout { display:grid; grid-template-columns: 240px 1fr; gap: 18px; }
      .admin-nav { border-right: 1px solid #eceef3; padding-right: 16px; }
      .admin-nav button { width: 100%; text-align: left; }
      .form-card { border-radius: 16px; border:1px solid #eceef3; padding: 16px; background: #fafbff; }
      .form-title { font-size: 15px; font-weight: 600; margin-bottom: 4px; }
      .form-subtitle { font-size: 12px; color:#666; margin-bottom: 12px; }
      .badge { display:inline-flex; align-items:center; padding: 4px 10px; border-radius: 999px; font-size: 11px; background:#fff; border:1px solid #d7dbe4; }
      .badge.online { border-color: #2ecc71; }
      .badge.offline { border-color: #b9bcc6; }
      .chat-launcher { position: fixed; right: 24px; bottom: 24px; width: 56px; height: 56px; border-radius: 50%; background: #111; color:#fff; display:flex; align-items:center; justify-content:center; cursor:pointer; box-shadow: 0 10px 20px rgba(0,0,0,.2); z-index: 10; }
      .chat-badge { position:absolute; top: -4px; right: -4px; background:#e53935; color:#fff; border-radius: 999px; padding: 2px 6px; font-size: 11px; }
      .chat-panel { position: fixed; right: 24px; bottom: 92px; width: 360px; max-width: calc(100vw - 40px); background:#fff; border-radius: 18px; box-shadow: 0 14px 30px rgba(0,0,0,.2); border:1px solid #e6e8ef; display:none; flex-direction: column; z-index: 10; }
      .chat-header { display:flex; align-items:center; justify-content: space-between; padding: 12px 14px; border-bottom:1px solid #eef0f6; }
      .chat-body { display:grid; grid-template-columns: 140px 1fr; min-height: 360px; max-height: 500px; }
      .chat-users { border-right:1px solid #eef0f6; overflow-y: auto; }
      .chat-users input { border-radius: 0; border:0; border-bottom:1px solid #eef0f6; }
      .chat-user { padding: 10px; border-bottom:1px solid #f1f2f6; cursor:pointer; }
      .chat-user.active { background:#f5f6ff; }
      .chat-user-name { font-size: 13px; font-weight: 600; }
      .chat-role { margin-top: 4px; }
      .chat-messages { display:flex; flex-direction: column; height: 100%; }
      .chat-list { flex:1; padding: 12px; overflow-y: auto; }
      .chat-message { margin-bottom: 12px; max-width: 80%; }
      .chat-message.me { margin-left: auto; text-align: right; }
      .chat-bubble { background:#f1f2f6; padding: 8px 10px; border-radius: 12px; display:inline-block; }
      .chat-message.me .chat-bubble { background:#111; color:#fff; }
      .chat-meta { font-size: 10px; color:#666; margin-top: 4px; }
      .chat-input { border-top:1px solid #eef0f6; padding: 10px; display:flex; flex-direction: column; gap: 8px; }
      .chat-input-row { display:flex; gap: 8px; }
      .chat-input-row button { flex:0; white-space: nowrap; }
      .notification-item { padding: 12px; border-radius: 12px; border:1px solid #eef0f6; background:#fafbff; margin-bottom: 10px; }
      .notification-title { font-weight: 600; font-size: 13px; margin-bottom: 4px; }
      .notification-meta { font-size: 11px; color:#666; margin-top: 6px; }
      .fade-in { animation: fadeIn .25s ease; }
      @keyframes fadeIn { from { opacity: 0; transform: translateY(4px); } to { opacity: 1; transform: translateY(0); } }
      @media (max-width: 960px) {
        .admin-layout { grid-template-columns: 1fr; }
        .admin-nav { border-right:0; border-bottom: 1px solid #eceef3; padding-bottom: 12px; }
      }
      @media (max-width: 680px) {
        .chat-panel { width: calc(100vw - 32px); right: 16px; }
        .chat-body { grid-template-columns: 1fr; }
        .chat-users { max-height: 160px; }
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <div class="card" id="screenLogin" style="display:none;">
        <div class="top">
          <h1>üîê –í—Ö–æ–¥</h1>
          <span class="pill">–ü–∏–ª–æ—Ç</span>
        </div>
        <div class="muted">–õ–æ–≥–∏–Ω/–ø–∞—Ä–æ–ª—å —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ Google Sheets (–ø–∞—Ä–æ–ª—å ‚Äî –≤ –≤–∏–¥–µ —Ö—ç—à–∞). –°–µ—Å—Å–∏—è –∑–∞–ø–æ–º–∏–Ω–∞–µ—Ç—Å—è –≤ –±—Ä–∞—É–∑–µ—Ä–µ.</div>

        <label>–õ–æ–≥–∏–Ω</label>
        <input id="login" autocomplete="username" />

        <label>–ü–∞—Ä–æ–ª—å</label>
        <input id="password" type="password" autocomplete="current-password" />

        <div class="row">
          <button class="primary" onclick="login()">–í–æ–π—Ç–∏</button>
          <button class="ghost" onclick="clearSaved()">–°–±—Ä–æ—Å–∏—Ç—å</button>
        </div>

        <div id="msgLogin" class="err" style="display:none;"></div>
      </div>

      <div class="card" id="screenAuthed" style="display:none;">
        <div class="top">
          <h1>‚úÖ –í—ã –≤–æ—à–ª–∏</h1>
          <button class="ghost" style="flex:0; padding:8px 10px;" onclick="logout()">–í—ã–π—Ç–∏</button>
        </div>
        <div class="kv"><b>–°–æ—Ç—Ä—É–¥–Ω–∏–∫:</b> <span id="uName"></span></div>
        <div class="kv"><b>–†–æ–ª—å:</b> <span id="uRole"></span></div>
        <div class="kv"><b>–£—á–∞—Å—Ç–æ–∫:</b> <span id="uArea"></span></div>

        <hr style="border:0;border-top:1px solid #eee;margin:14px 0;" />

        <div class="muted">
          –°–ª–µ–¥—É—é—â–∏–π —à–∞–≥: –¥–æ–±–∞–≤–∏—Ç—å —ç–∫—Ä–∞–Ω ‚Äú–°–∫–∞–Ω –∏–∑–¥–µ–ª–∏—è + –∫–Ω–æ–ø–∫–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏‚Äù –∏ –ø–∏—Å–∞—Ç—å —Å–æ–±—ã—Ç–∏—è –≤ –ª–∏—Å—Ç <b>–°–û–ë–´–¢–ò–Ø</b>.
        </div>
      </div>

      <div class="card" id="screenBossMenu" style="display:none;">
        <div class="top">
          <h1>üß≠ –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é</h1>
          <button class="ghost" style="flex:0; padding:8px 10px;" onclick="logout()">–í—ã–π—Ç–∏</button>
        </div>
        <div class="kv"><b>–ù–∞—á–∞–ª—å–Ω–∏–∫:</b> <span id="bossName"></span></div>
        <div class="menu">
          <button class="primary" onclick="openPersonnel()">–ü–µ—Ä—Å–æ–Ω–∞–ª</button>
          <button class="ghost" onclick="openNotifications()">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</button>
        </div>
      </div>

      <div class="card" id="screenBossPersonnel" style="display:none;">
        <div class="top">
          <h1>üë• –ü–µ—Ä—Å–æ–Ω–∞–ª</h1>
          <button class="ghost" style="flex:0; padding:8px 10px;" onclick="show('screenBossMenu')">–ù–∞–∑–∞–¥</button>
        </div>
        <div class="muted">–°–Ω–∞—á–∞–ª–∞ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –∞–∫—Ç–∏–≤–Ω—ã–µ —Å–µ—Å—Å–∏–∏, –∑–∞—Ç–µ–º –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏.</div>
        <div id="staffError" class="err" style="display:none;"></div>
        <div class="section-title">–ê–∫—Ç–∏–≤–Ω—ã–µ</div>
        <ul class="staff-list" id="staffActive"></ul>
        <div class="section-title">–ù–µ–∞–∫—Ç–∏–≤–Ω—ã–µ</div>
        <ul class="staff-list" id="staffInactive"></ul>
      </div>

      <div class="card" id="screenBossNotifications" style="display:none;">
        <div class="top">
          <h1>üîî –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</h1>
          <button class="ghost" style="flex:0; padding:8px 10px;" onclick="show('screenBossMenu')">–ù–∞–∑–∞–¥</button>
        </div>
        <div class="muted">–ò—Å—Ç–æ—Ä–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π. –ú–æ–∂–Ω–æ —É–¥–∞–ª—è—Ç—å –∑–∞–ø–∏—Å–∏.</div>
        <div id="notificationsError" class="err" style="display:none;"></div>
        <div id="notificationsList"></div>
      </div>

      <div class="card" id="screenAdmin" style="display:none;">
        <div class="top">
          <h1>üß© –ö–∞–±–∏–Ω–µ—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</h1>
          <button class="ghost" style="flex:0; padding:8px 10px;" onclick="logout()">–í—ã–π—Ç–∏</button>
        </div>
        <div class="kv"><b>–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä:</b> <span id="adminName"></span></div>
        <div class="kv"><b>–†–æ–ª—å:</b> <span id="adminRole"></span></div>

        <div class="admin-layout" style="margin-top:16px;">
          <div class="admin-nav">
            <div class="section-title">–ú–µ–Ω—é –∑–∞—è–≤–æ–∫</div>
            <button class="primary" onclick="openCuttingForm('–ó–∞–¥–∞–Ω–∏–µ –Ω–∞ —Ä–∞—Å–∫—Ä–æ–π1')">–ó–∞–¥–∞–Ω–∏–µ –Ω–∞ —Ä–∞—Å–∫—Ä–æ–π1</button>
            <button class="ghost" onclick="openCuttingForm('–ó–∞–¥–∞–Ω–∏–µ –Ω–∞ —Ä–∞—Å–∫—Ä–æ–π2')">–ó–∞–¥–∞–Ω–∏–µ –Ω–∞ —Ä–∞—Å–∫—Ä–æ–π2</button>
            <button class="ghost" onclick="openCuttingForm('–ó–∞–¥–∞–Ω–∏–µ –Ω–∞ —Ä–∞—Å–∫—Ä–æ–π3')">–ó–∞–¥–∞–Ω–∏–µ –Ω–∞ —Ä–∞—Å–∫—Ä–æ–π3</button>
            <div class="section-title">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ</div>
            <button class="ghost" id="bossPanelBtn" style="display:none;" onclick="show('screenBossMenu')">–ü–∞–Ω–µ–ª—å –Ω–∞—á–∞–ª—å–Ω–∏–∫–∞</button>
          </div>
          <div>
            <div class="form-card fade-in">
              <div class="form-title" id="cuttingFormTitle">–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–¥–∞–Ω–∏–µ</div>
              <div class="form-subtitle" id="cuttingFormSubtitle">–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å –∫–Ω–æ–ø–∫—É –æ—Ç–ø—Ä–∞–≤–∫–∏.</div>
              <form id="cuttingForm">
                <div class="grid">
                  <div>
                    <label>–ú–∞—Ä–∫–µ—Ä –∏–∑–¥–µ–ª–∏—è</label>
                    <input type="text" name="id_product" required />
                    <div class="field-note">–£–Ω–∏–∫–∞–ª—å–Ω—ã–π –º–∞—Ä–∫–µ—Ä, –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –Ω–∞ —Å—Ç–µ–∫–ª–µ.</div>
                  </div>
                  <div>
                    <label>–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</label>
                    <select name="direction" required>
                      <option value="">–í—ã–±–µ—Ä–∏—Ç–µ</option>
                      <option value="–í–æ—Å–ø–æ–ª–Ω–µ–Ω–∏–µ">–í–æ—Å–ø–æ–ª–Ω–µ–Ω–∏–µ</option>
                      <option value="–†–µ–∑–∫–∞">–†–µ–∑–∫–∞</option>
                    </select>
                  </div>
                  <div>
                    <label>–°–ª–µ–¥—É—é—â–∏–π –ø—Ä–æ—Ü–µ—Å—Å</label>
                    <select name="process" required>
                      <option value="">–í—ã–±–µ—Ä–∏—Ç–µ</option>
                      <option value="–°–±–æ—Ä–∫–∞">–°–±–æ—Ä–∫–∞</option>
                      <option value="–ó–∞–∫–∞–ª–∫–∞">–ó–∞–∫–∞–ª–∫–∞</option>
                      <option value="–û–±—Ä–∞–±–æ—Ç–∫–∞">–û–±—Ä–∞–±–æ—Ç–∫–∞</option>
                      <option value="–î–∞–±–ª">–î–∞–±–ª</option>
                      <option value="–¢—Ä–∏–ø–ª–µ–∫—Å">–¢—Ä–∏–ø–ª–µ–∫—Å</option>
                    </select>
                  </div>
                  <div>
                    <label>–®–∏—Ä–∏–Ω–∞ (–º–º)</label>
                    <input type="number" name="width_mm" step="0.01" required />
                  </div>
                  <div>
                    <label>–í—ã—Å–æ—Ç–∞ (–º–º)</label>
                    <input type="number" name="height_mm" step="0.01" required />
                  </div>
                  <div>
                    <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–∑–¥–µ–ª–∏–π</label>
                    <input type="number" name="quantity" step="0.01" required />
                  </div>
                  <div>
                    <label>–§–æ—Ä–º—É–ª–∞</label>
                    <input type="text" name="formula" required />
                  </div>
                  <div>
                    <label>–ü–µ—á–∞—Ç—å</label>
                    <select name="print" required>
                      <option value="">–í—ã–±–µ—Ä–∏—Ç–µ</option>
                      <option value="–î–∞">–î–∞</option>
                      <option value="–ù–µ—Ç">–ù–µ—Ç</option>
                    </select>
                  </div>
                  <div>
                    <label>–°—Ç–∏–∫–µ—Ä</label>
                    <select name="sticker" required>
                      <option value="">–í—ã–±–µ—Ä–∏—Ç–µ</option>
                      <option value="–î–∞">–î–∞</option>
                      <option value="–ù–µ—Ç">–ù–µ—Ç</option>
                    </select>
                  </div>
                  <div>
                    <label>–í —Ä—É—á–Ω—É—é</label>
                    <select name="manual" required>
                      <option value="">–í—ã–±–µ—Ä–∏—Ç–µ</option>
                      <option value="–î–∞">–î–∞</option>
                      <option value="–ù–µ—Ç">–ù–µ—Ç</option>
                    </select>
                  </div>
                  <div>
                    <label>–ü—Ä–∏–ø—É—Å–∫ (–º–º)</label>
                    <input type="number" name="allowance_mm" step="0.01" required />
                  </div>
                </div>
                <div class="row">
                  <button class="primary" id="submitCutting" type="submit" disabled>–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–¥–∞–Ω–∏–µ</button>
                  <button class="ghost" type="button" onclick="resetCuttingForm()">–û—á–∏—Å—Ç–∏—Ç—å</button>
                </div>
                <div id="cuttingFormMsg" class="err" style="display:none;"></div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="chat-launcher" onclick="toggleChat()" title="–û—Ç–∫—Ä—ã—Ç—å —á–∞—Ç">
      üí¨
      <span class="chat-badge" id="chatUnreadBadge" style="display:none;">0</span>
    </div>
    <div class="chat-panel" id="chatPanel">
      <div class="chat-header">
        <div>
          <div style="font-weight:600;">–õ–∏—á–Ω—ã–π —á–∞—Ç</div>
          <div class="muted" style="margin:0;">–°–æ–æ–±—â–µ–Ω–∏—è –∏ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏</div>
        </div>
        <button class="ghost" style="flex:0; padding:6px 10px;" onclick="toggleChat()">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
      <div class="chat-body">
        <div class="chat-users">
          <input id="chatSearch" placeholder="–ü–æ–∏—Å–∫..." oninput="renderChatUsers()" />
          <div id="chatUsersList"></div>
        </div>
        <div class="chat-messages">
          <div class="chat-list" id="chatMessages"></div>
          <div class="chat-input">
            <div id="chatSelectedUser" class="muted">–í—ã–±–µ—Ä–∏—Ç–µ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞.</div>
            <div class="chat-input-row">
              <input id="chatMessageInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." />
              <button class="ghost" type="button" onclick="triggerFilePicker()">–§–æ—Ç–æ</button>
              <button class="primary" type="button" onclick="sendChatMessage()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            </div>
            <input id="chatFileInput" type="file" accept="image/*" style="display:none;" />
            <div id="chatAttachmentNote" class="muted" style="margin:0;"></div>
            <div id="chatError" class="err" style="display:none;"></div>
          </div>
        </div>
      </div>
    </div>

    <script>
      const LS_TOKEN_KEY = 'pilot_session_token_v1';

      function setMsg(elId, text, ok=false) {
        const el = document.getElementById(elId);
        el.style.display = 'block';
        el.className = ok ? 'ok' : 'err';
        el.textContent = text;
      }
      function hideMsg(elId) {
        const el = document.getElementById(elId);
        el.style.display = 'none';
        el.textContent = '';
      }

      function show(screenId) {
        document.getElementById('screenLogin').style.display = 'none';
        document.getElementById('screenAuthed').style.display = 'none';
        document.getElementById('screenBossMenu').style.display = 'none';
        document.getElementById('screenBossPersonnel').style.display = 'none';
        document.getElementById('screenBossNotifications').style.display = 'none';
        document.getElementById('screenAdmin').style.display = 'none';
        document.getElementById(screenId).style.display = 'block';
      }

      function getSavedToken() {
        try { return localStorage.getItem(LS_TOKEN_KEY) || ''; } catch(e) { return ''; }
      }
      function saveToken(token) {
        try { localStorage.setItem(LS_TOKEN_KEY, token); } catch(e) {}
      }
      function clearSaved() {
        try { localStorage.removeItem(LS_TOKEN_KEY); } catch(e) {}
        setMsg('msgLogin', '–°–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–∞—è —Å–µ—Å—Å–∏—è —É–¥–∞–ª–µ–Ω–∞.', true);
      }

      function bootstrap() {
        const token = getSavedToken();
        google.script.run
          .withSuccessHandler(res => {
            if (!res || !res.ok) { show('screenLogin'); return; }
            if (res.auth && res.auth.isAuthed) {
              saveToken(res.auth.token);
              renderUser(res.auth.user);
              showAuthedScreen(res.auth.user);
              initChat();
              return;
            }
            show('screenLogin');
            setTimeout(() => document.getElementById('login').focus(), 50);
          })
          .withFailureHandler(err => {
            show('screenLogin');
            setMsg('msgLogin', '–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏: ' + (err && err.message ? err.message : err));
          })
          .apiBootstrap({ token });
      }

      function login() {
        hideMsg('msgLogin');
        const login = document.getElementById('login').value.trim();
        const password = document.getElementById('password').value;

        if (!login || !password) {
          setMsg('msgLogin', '–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å.');
          return;
        }

        google.script.run
          .withSuccessHandler(res => {
            if (!res || !res.ok) {
              setMsg('msgLogin', (res && res.error) ? res.error : '–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞');
              return;
            }
            saveToken(res.token);
            renderUser(res.user);
            showAuthedScreen(res.user);
            initChat();
          })
          .withFailureHandler(err => {
            setMsg('msgLogin', '–û—à–∏–±–∫–∞: ' + (err && err.message ? err.message : err));
          })
          .apiLogin({ login, password });
      }

      function logout() {
        const token = getSavedToken();
        try { localStorage.removeItem(LS_TOKEN_KEY); } catch(e) {}

        google.script.run
          .withSuccessHandler(() => {
            show('screenLogin');
            document.getElementById('password').value = '';
            setTimeout(() => document.getElementById('login').focus(), 50);
          })
          .withFailureHandler(() => {
            show('screenLogin');
          })
          .apiLogout({ token });
      }

      function renderUser(u) {
        document.getElementById('uName').textContent = u && u.name ? u.name : '';
        document.getElementById('uRole').textContent = u && u.role ? u.role : '';
        document.getElementById('uArea').textContent = u && u.area ? u.area : '';
      }

      function showAuthedScreen(u) {
        const roles = (u && u.role) ? String(u.role) : '';
        const hasBoss = hasRole(roles, '–ù–∞—á–∞–ª—å–Ω–∏–∫');
        const hasAdmin = hasRole(roles, '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä');
        if (hasBoss && !hasAdmin) {
          document.getElementById('bossName').textContent = u && u.name ? u.name : '';
          show('screenBossMenu');
          return;
        }
        if (hasAdmin) {
          document.getElementById('adminName').textContent = u && u.name ? u.name : '';
          document.getElementById('adminRole').textContent = roles;
          document.getElementById('bossPanelBtn').style.display = hasBoss ? 'block' : 'none';
          show('screenAdmin');
          return;
        }
        show('screenAuthed');
      }

      function openPersonnel() {
        hideMsg('staffError');
        show('screenBossPersonnel');
        loadStaff();
      }

      function loadStaff() {
        const token = getSavedToken();
        google.script.run
          .withSuccessHandler(res => {
            if (!res || !res.ok) {
              setMsg('staffError', (res && res.error) ? res.error : '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª.');
              return;
            }
            renderStaffList('staffActive', res.active || [], true);
            renderStaffList('staffInactive', res.inactive || [], false);
          })
          .withFailureHandler(err => {
            setMsg('staffError', '–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏: ' + (err && err.message ? err.message : err));
          })
          .apiGetStaff({ token });
      }

      function renderStaffList(elId, list, isActive) {
        const el = document.getElementById(elId);
        el.innerHTML = '';
        if (!list.length) {
          const li = document.createElement('li');
          li.className = 'staff-item';
          li.textContent = isActive ? '–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–µ—Å—Å–∏–π.' : '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö.';
          el.appendChild(li);
          return;
        }

        list.forEach(item => {
          const li = document.createElement('li');
          li.className = 'staff-item';
          const title = document.createElement('div');
          title.textContent = item.name || '–ë–µ–∑ –∏–º–µ–Ω–∏';
          const meta = document.createElement('div');
          const area = item.area ? `–£—á–∞—Å—Ç–æ–∫: ${item.area}` : '–£—á–∞—Å—Ç–æ–∫: ‚Äî';
          const time = isActive ? item.session_started_at : item.last_login_at;
          const timeLabel = isActive ? '–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è' : '–ü–æ—Å–ª–µ–¥–Ω–∏–π –≤—Ö–æ–¥';
          meta.className = 'staff-meta';
          meta.textContent = `${area} ¬∑ ${timeLabel}: ${formatDateTime(time)}`;
          li.appendChild(title);
          li.appendChild(meta);
          el.appendChild(li);
        });
      }

      function formatDateTime(value) {
        if (!value) return '‚Äî';
        const date = new Date(value);
        if (Number.isNaN(date.getTime())) return '‚Äî';
        const pad = num => String(num).padStart(2, '0');
        return `${pad(date.getDate())}.${pad(date.getMonth() + 1)}.${date.getFullYear()} ${pad(date.getHours())}:${pad(date.getMinutes())}`;
      }

      function hasRole(roles, role) {
        return String(roles || '')
          .split(',')
          .map(item => item.trim().toLowerCase())
          .includes(String(role || '').trim().toLowerCase());
      }

      let currentMenuTitle = '';
      function openCuttingForm(title) {
        currentMenuTitle = title;
        document.getElementById('cuttingFormTitle').textContent = title;
        document.getElementById('cuttingFormSubtitle').textContent = '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å –∫–Ω–æ–ø–∫—É –æ—Ç–ø—Ä–∞–≤–∫–∏.';
        resetCuttingForm();
      }

      function resetCuttingForm() {
        const form = document.getElementById('cuttingForm');
        form.reset();
        document.getElementById('cuttingFormMsg').style.display = 'none';
        updateCuttingSubmitState();
      }

      function updateCuttingSubmitState() {
        const form = document.getElementById('cuttingForm');
        const required = form.querySelectorAll('[required]');
        let filled = true;
        required.forEach(field => {
          if (!field.value || String(field.value).trim() === '') filled = false;
        });
        document.getElementById('submitCutting').disabled = !filled || !currentMenuTitle;
      }

      document.getElementById('cuttingForm').addEventListener('input', updateCuttingSubmitState);
      document.getElementById('cuttingForm').addEventListener('submit', event => {
        event.preventDefault();
        const msg = document.getElementById('cuttingFormMsg');
        msg.style.display = 'none';
        if (!currentMenuTitle) {
          msg.textContent = '–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –º–µ–Ω—é.';
          msg.style.display = 'block';
          return;
        }
        const form = event.target;
        const data = Object.fromEntries(new FormData(form).entries());
        data.menu_title = currentMenuTitle;
        const token = getSavedToken();
        google.script.run
          .withSuccessHandler(res => {
            if (!res || !res.ok) {
              msg.className = 'err';
              msg.textContent = (res && res.error) ? res.error : '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–¥–∞–Ω–∏–µ.';
              msg.style.display = 'block';
              return;
            }
            msg.className = 'ok';
            msg.textContent = '–ó–∞–¥–∞–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ. –ù–æ–º–µ—Ä: ' + res.order_id;
            msg.style.display = 'block';
            resetCuttingForm();
          })
          .withFailureHandler(err => {
            msg.className = 'err';
            msg.textContent = '–û—à–∏–±–∫–∞: ' + (err && err.message ? err.message : err);
            msg.style.display = 'block';
          })
          .apiCreateCuttingOrder({ token, data });
      });

      function openNotifications() {
        show('screenBossNotifications');
        loadNotifications();
      }

      function loadNotifications() {
        const token = getSavedToken();
        const error = document.getElementById('notificationsError');
        error.style.display = 'none';
        google.script.run
          .withSuccessHandler(res => {
            if (!res || !res.ok) {
              error.textContent = (res && res.error) ? res.error : '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è.';
              error.style.display = 'block';
              return;
            }
            renderNotifications(res.list || []);
          })
          .withFailureHandler(err => {
            error.textContent = '–û—à–∏–±–∫–∞: ' + (err && err.message ? err.message : err);
            error.style.display = 'block';
          })
          .apiGetNotifications({ token });
      }

      function renderNotifications(list) {
        const container = document.getElementById('notificationsList');
        container.innerHTML = '';
        if (!list.length) {
          container.innerHTML = '<div class="muted">–ù–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π.</div>';
          return;
        }
        list.forEach(item => {
          const card = document.createElement('div');
          card.className = 'notification-item';
          const title = document.createElement('div');
          title.className = 'notification-title';
          title.textContent = item.title || '–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ';
          const message = document.createElement('div');
          message.textContent = item.message || '';
          const meta = document.createElement('div');
          meta.className = 'notification-meta';
          meta.textContent = `–°–æ–∑–¥–∞–Ω–æ: ${formatDateTime(item.created_at)}`;
          const btn = document.createElement('button');
          btn.className = 'ghost';
          btn.style.marginTop = '8px';
          btn.textContent = '–£–¥–∞–ª–∏—Ç—å';
          btn.onclick = () => deleteNotification(item.notification_id);
          card.appendChild(title);
          card.appendChild(message);
          card.appendChild(meta);
          card.appendChild(btn);
          container.appendChild(card);
        });
      }

      function deleteNotification(notificationId) {
        const token = getSavedToken();
        google.script.run
          .withSuccessHandler(res => {
            if (!res || !res.ok) return;
            loadNotifications();
          })
          .apiDeleteNotification({ token, notification_id: notificationId });
      }

      let chatUsers = [];
      let currentChatUser = null;
      let chatRefreshTimer = null;
      let pendingAttachment = null;

      function initChat() {
        if (chatRefreshTimer) return;
        fetchChatUsers();
        updateChatUnreadBadge();
        chatRefreshTimer = setInterval(() => {
          updateChatUnreadBadge();
          if (currentChatUser) loadChatThread(currentChatUser.user_id, false);
        }, 15000);
      }

      function toggleChat() {
        const panel = document.getElementById('chatPanel');
        const isVisible = panel.style.display === 'flex';
        panel.style.display = isVisible ? 'none' : 'flex';
        if (!isVisible) {
          fetchChatUsers();
          updateChatUnreadBadge();
        }
      }

      function fetchChatUsers() {
        const token = getSavedToken();
        google.script.run
          .withSuccessHandler(res => {
            if (!res || !res.ok) return;
            chatUsers = res.list || [];
            renderChatUsers();
          })
          .apiGetChatUsers({ token });
      }

      function renderChatUsers() {
        const listEl = document.getElementById('chatUsersList');
        const query = document.getElementById('chatSearch').value.toLowerCase();
        const sorted = [...chatUsers].sort((a, b) => {
          if (a.is_online !== b.is_online) return a.is_online ? -1 : 1;
          return (a.name || '').localeCompare(b.name || '');
        });
        listEl.innerHTML = '';
        sorted
          .filter(u => (u.name || '').toLowerCase().includes(query))
          .forEach(user => {
            const item = document.createElement('div');
            item.className = 'chat-user' + (currentChatUser && currentChatUser.user_id === user.user_id ? ' active' : '');
            item.onclick = () => selectChatUser(user);
            const name = document.createElement('div');
            name.className = 'chat-user-name';
            name.textContent = user.name || '–ë–µ–∑ –∏–º–µ–Ω–∏';
            const role = document.createElement('div');
            role.className = 'chat-role';
            const badge = document.createElement('span');
            badge.className = 'badge ' + (user.is_online ? 'online' : 'offline');
            badge.textContent = user.role || '‚Äî';
            role.appendChild(badge);
            item.appendChild(name);
            item.appendChild(role);
            listEl.appendChild(item);
          });
      }

      function selectChatUser(user) {
        currentChatUser = user;
        document.getElementById('chatSelectedUser').textContent = `–î–∏–∞–ª–æ–≥ —Å ${user.name || '–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º'}`;
        pendingAttachment = null;
        document.getElementById('chatAttachmentNote').textContent = '';
        loadChatThread(user.user_id, true);
        renderChatUsers();
      }

      function loadChatThread(userId, markRead) {
        const token = getSavedToken();
        google.script.run
          .withSuccessHandler(res => {
            if (!res || !res.ok) return;
            renderChatMessages(res.list || []);
            if (markRead) markChatRead(userId);
          })
          .apiGetChatThread({ token, other_user_id: userId });
      }

      function renderChatMessages(list) {
        const container = document.getElementById('chatMessages');
        container.innerHTML = '';
        if (!list.length) {
          container.innerHTML = '<div class="muted">–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π.</div>';
          return;
        }
        list.forEach(item => {
          const message = document.createElement('div');
          message.className = 'chat-message' + (item.from_user_id === getCurrentUserId() ? ' me' : '');
          const bubble = document.createElement('div');
          bubble.className = 'chat-bubble';
          if (item.text) {
            const text = document.createElement('div');
            text.textContent = item.text;
            bubble.appendChild(text);
          }
          if (item.attachment_url) {
            const img = document.createElement('img');
            img.src = item.attachment_url;
            img.alt = item.attachment_name || '–§–æ—Ç–æ';
            img.style.maxWidth = '160px';
            img.style.marginTop = '6px';
            img.style.borderRadius = '8px';
            bubble.appendChild(img);
          }
          const meta = document.createElement('div');
          meta.className = 'chat-meta';
          meta.textContent = formatDateTime(item.created_at);
          message.appendChild(bubble);
          message.appendChild(meta);
          container.appendChild(message);
        });
        container.scrollTop = container.scrollHeight;
      }

      function sendChatMessage() {
        const error = document.getElementById('chatError');
        error.style.display = 'none';
        if (!currentChatUser) {
          error.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞.';
          error.style.display = 'block';
          return;
        }
        const text = document.getElementById('chatMessageInput').value.trim();
        if (!text && !pendingAttachment) {
          error.textContent = '–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–ª–∏ –ø—Ä–∏–∫—Ä–µ–ø–∏—Ç–µ —Ñ–æ—Ç–æ.';
          error.style.display = 'block';
          return;
        }
        const token = getSavedToken();
        google.script.run
          .withSuccessHandler(res => {
            if (!res || !res.ok) {
              error.textContent = (res && res.error) ? res.error : '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ.';
              error.style.display = 'block';
              return;
            }
            document.getElementById('chatMessageInput').value = '';
            pendingAttachment = null;
            document.getElementById('chatAttachmentNote').textContent = '';
            loadChatThread(currentChatUser.user_id, true);
            updateChatUnreadBadge();
          })
          .withFailureHandler(err => {
            error.textContent = '–û—à–∏–±–∫–∞: ' + (err && err.message ? err.message : err);
            error.style.display = 'block';
          })
          .apiSendChatMessage({ token, to_user_id: currentChatUser.user_id, text, attachment: pendingAttachment });
      }

      function markChatRead(userId) {
        const token = getSavedToken();
        google.script.run
          .withSuccessHandler(() => updateChatUnreadBadge())
          .apiMarkChatRead({ token, other_user_id: userId });
      }

      function updateChatUnreadBadge() {
        const token = getSavedToken();
        google.script.run
          .withSuccessHandler(res => {
            if (!res || !res.ok) return;
            const badge = document.getElementById('chatUnreadBadge');
            const count = Number(res.count || 0);
            if (count > 0) {
              badge.textContent = count;
              badge.style.display = 'inline-block';
            } else {
              badge.style.display = 'none';
            }
          })
          .apiGetChatUnreadCount({ token });
      }

      function triggerFilePicker() {
        const input = document.getElementById('chatFileInput');
        input.click();
      }

      document.getElementById('chatFileInput').addEventListener('change', event => {
        const file = event.target.files[0];
        if (!file) return;
        const error = document.getElementById('chatError');
        error.style.display = 'none';
        if (file.size > 10 * 1024 * 1024) {
          error.textContent = '–§–∞–π–ª –ø—Ä–µ–≤—ã—à–∞–µ—Ç 10 –ú–ë.';
          error.style.display = 'block';
          return;
        }
        const reader = new FileReader();
        reader.onload = () => {
          const base64 = String(reader.result || '').split(',')[1] || '';
          pendingAttachment = {
            name: file.name,
            type: file.type,
            size: file.size,
            content: base64
          };
          document.getElementById('chatAttachmentNote').textContent = `–§–æ—Ç–æ: ${file.name}`;
        };
        reader.readAsDataURL(file);
      });

      function getCurrentUserId() {
        return (window.currentUser && currentUser.user_id) ? window.currentUser.user_id : '';
      }

      const originalRenderUser = renderUser;
      renderUser = function(u) {
        window.currentUser = u || null;
        originalRenderUser(u);
      }

      bootstrap();
    </script>
  </body>
</html>
