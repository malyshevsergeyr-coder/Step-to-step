<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      body { font-family: Arial, sans-serif; margin: 0; background:#f6f7f9; }
      .wrap { max-width: 520px; margin: 24px auto; padding: 16px; }
      .card { background:#fff; border-radius: 14px; padding: 18px; box-shadow: 0 6px 18px rgba(0,0,0,.08); }
      h1 { font-size: 18px; margin: 0 0 12px; }
      .muted { color:#666; font-size: 12px; margin-bottom: 12px; }
      label { display:block; font-size: 12px; color:#333; margin-top: 10px; }
      input { width:100%; padding: 10px 12px; font-size: 14px; border:1px solid #ddd; border-radius: 10px; outline:none; }
      input:focus { border-color:#999; }
      .row { display:flex; gap:10px; margin-top: 12px; flex-wrap: wrap; }
      button { flex:1; padding: 11px 12px; font-size: 14px; border:0; border-radius: 10px; cursor:pointer; }
      .primary { background:#111; color:#fff; }
      .ghost { background:#eee; }
      .pill { display:inline-block; padding: 6px 10px; border-radius: 999px; background:#eee; font-size: 12px; }
      .err { color:#b00020; font-size: 13px; margin-top: 10px; }
      .ok { color:#0a7a28; font-size: 13px; margin-top: 10px; }
      .top { display:flex; justify-content:space-between; align-items:center; margin-bottom: 10px; }
      .kv { font-size: 13px; margin-top: 8px; }
      .kv b { display:inline-block; min-width: 90px; }
      .menu { display:flex; flex-direction: column; gap: 10px; margin-top: 12px; }
      .menu button { width: 100%; text-align: left; }
      .section-title { font-size: 13px; font-weight: 600; margin: 14px 0 6px; }
      .staff-list { list-style: none; padding: 0; margin: 0; }
      .staff-item { padding: 10px 0; border-bottom: 1px solid #eee; font-size: 13px; }
      .staff-item:last-child { border-bottom: 0; }
      .staff-meta { color: #666; font-size: 12px; margin-top: 4px; }
    </style>
  </head>
  <body>
    <div class="wrap">
      <div class="card" id="screenLogin" style="display:none;">
        <div class="top">
          <h1>üîê –í—Ö–æ–¥</h1>
          <span class="pill">–ü–∏–ª–æ—Ç</span>
        </div>
        <div class="muted">–õ–æ–≥–∏–Ω/–ø–∞—Ä–æ–ª—å —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ Google Sheets (–ø–∞—Ä–æ–ª—å ‚Äî –≤ –≤–∏–¥–µ —Ö—ç—à–∞). –°–µ—Å—Å–∏—è –∑–∞–ø–æ–º–∏–Ω–∞–µ—Ç—Å—è –≤ –±—Ä–∞—É–∑–µ—Ä–µ.</div>

        <label>–õ–æ–≥–∏–Ω</label>
        <input id="login" autocomplete="username" />

        <label>–ü–∞—Ä–æ–ª—å</label>
        <input id="password" type="password" autocomplete="current-password" />

        <div class="row">
          <button class="primary" onclick="login()">–í–æ–π—Ç–∏</button>
          <button class="ghost" onclick="clearSaved()">–°–±—Ä–æ—Å–∏—Ç—å</button>
        </div>

        <div id="msgLogin" class="err" style="display:none;"></div>
      </div>

      <div class="card" id="screenAuthed" style="display:none;">
        <div class="top">
          <h1>‚úÖ –í—ã –≤–æ—à–ª–∏</h1>
          <button class="ghost" style="flex:0; padding:8px 10px;" onclick="logout()">–í—ã–π—Ç–∏</button>
        </div>
        <div class="kv"><b>–°–æ—Ç—Ä—É–¥–Ω–∏–∫:</b> <span id="uName"></span></div>
        <div class="kv"><b>–†–æ–ª—å:</b> <span id="uRole"></span></div>
        <div class="kv"><b>–£—á–∞—Å—Ç–æ–∫:</b> <span id="uArea"></span></div>

        <hr style="border:0;border-top:1px solid #eee;margin:14px 0;" />

        <div class="muted">
          –°–ª–µ–¥—É—é—â–∏–π —à–∞–≥: –¥–æ–±–∞–≤–∏—Ç—å —ç–∫—Ä–∞–Ω ‚Äú–°–∫–∞–Ω –∏–∑–¥–µ–ª–∏—è + –∫–Ω–æ–ø–∫–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏‚Äù –∏ –ø–∏—Å–∞—Ç—å —Å–æ–±—ã—Ç–∏—è –≤ –ª–∏—Å—Ç <b>–°–û–ë–´–¢–ò–Ø</b>.
        </div>
      </div>

      <div class="card" id="screenBossMenu" style="display:none;">
        <div class="top">
          <h1>üß≠ –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é</h1>
          <button class="ghost" style="flex:0; padding:8px 10px;" onclick="logout()">–í—ã–π—Ç–∏</button>
        </div>
        <div class="kv"><b>–ù–∞—á–∞–ª—å–Ω–∏–∫:</b> <span id="bossName"></span></div>
        <div class="menu">
          <button class="primary" onclick="openPersonnel()">–ü–µ—Ä—Å–æ–Ω–∞–ª</button>
        </div>
      </div>

      <div class="card" id="screenBossPersonnel" style="display:none;">
        <div class="top">
          <h1>üë• –ü–µ—Ä—Å–æ–Ω–∞–ª</h1>
          <button class="ghost" style="flex:0; padding:8px 10px;" onclick="show('screenBossMenu')">–ù–∞–∑–∞–¥</button>
        </div>
        <div class="muted">–°–Ω–∞—á–∞–ª–∞ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –∞–∫—Ç–∏–≤–Ω—ã–µ —Å–µ—Å—Å–∏–∏, –∑–∞—Ç–µ–º –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏.</div>
        <div id="staffError" class="err" style="display:none;"></div>
        <div class="section-title">–ê–∫—Ç–∏–≤–Ω—ã–µ</div>
        <ul class="staff-list" id="staffActive"></ul>
        <div class="section-title">–ù–µ–∞–∫—Ç–∏–≤–Ω—ã–µ</div>
        <ul class="staff-list" id="staffInactive"></ul>
      </div>
    </div>

    <script>
      const LS_TOKEN_KEY = 'pilot_session_token_v1';

      function setMsg(elId, text, ok=false) {
        const el = document.getElementById(elId);
        el.style.display = 'block';
        el.className = ok ? 'ok' : 'err';
        el.textContent = text;
      }
      function hideMsg(elId) {
        const el = document.getElementById(elId);
        el.style.display = 'none';
        el.textContent = '';
      }

      function show(screenId) {
        document.getElementById('screenLogin').style.display = 'none';
        document.getElementById('screenAuthed').style.display = 'none';
        document.getElementById('screenBossMenu').style.display = 'none';
        document.getElementById('screenBossPersonnel').style.display = 'none';
        document.getElementById(screenId).style.display = 'block';
      }

      function getSavedToken() {
        try { return localStorage.getItem(LS_TOKEN_KEY) || ''; } catch(e) { return ''; }
      }
      function saveToken(token) {
        try { localStorage.setItem(LS_TOKEN_KEY, token); } catch(e) {}
      }
      function clearSaved() {
        try { localStorage.removeItem(LS_TOKEN_KEY); } catch(e) {}
        setMsg('msgLogin', '–°–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–∞—è —Å–µ—Å—Å–∏—è —É–¥–∞–ª–µ–Ω–∞.', true);
      }

      function bootstrap() {
        const token = getSavedToken();
        google.script.run
          .withSuccessHandler(res => {
            if (!res || !res.ok) { show('screenLogin'); return; }
            if (res.auth && res.auth.isAuthed) {
              saveToken(res.auth.token);
              renderUser(res.auth.user);
              showAuthedScreen(res.auth.user);
              return;
            }
            show('screenLogin');
            setTimeout(() => document.getElementById('login').focus(), 50);
          })
          .withFailureHandler(err => {
            show('screenLogin');
            setMsg('msgLogin', '–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏: ' + (err && err.message ? err.message : err));
          })
          .apiBootstrap({ token });
      }

      function login() {
        hideMsg('msgLogin');
        const login = document.getElementById('login').value.trim();
        const password = document.getElementById('password').value;

        if (!login || !password) {
          setMsg('msgLogin', '–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å.');
          return;
        }

        google.script.run
          .withSuccessHandler(res => {
            if (!res || !res.ok) {
              setMsg('msgLogin', (res && res.error) ? res.error : '–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞');
              return;
            }
            saveToken(res.token);
            renderUser(res.user);
            showAuthedScreen(res.user);
          })
          .withFailureHandler(err => {
            setMsg('msgLogin', '–û—à–∏–±–∫–∞: ' + (err && err.message ? err.message : err));
          })
          .apiLogin({ login, password });
      }

      function logout() {
        const token = getSavedToken();
        try { localStorage.removeItem(LS_TOKEN_KEY); } catch(e) {}

        google.script.run
          .withSuccessHandler(() => {
            show('screenLogin');
            document.getElementById('password').value = '';
            setTimeout(() => document.getElementById('login').focus(), 50);
          })
          .withFailureHandler(() => {
            show('screenLogin');
          })
          .apiLogout({ token });
      }

      function renderUser(u) {
        document.getElementById('uName').textContent = u && u.name ? u.name : '';
        document.getElementById('uRole').textContent = u && u.role ? u.role : '';
        document.getElementById('uArea').textContent = u && u.area ? u.area : '';
      }

      function showAuthedScreen(u) {
        const role = (u && u.role) ? String(u.role).trim() : '';
        if (role === '–ù–∞—á–∞–ª—å–Ω–∏–∫') {
          document.getElementById('bossName').textContent = u && u.name ? u.name : '';
          show('screenBossMenu');
          return;
        }
        show('screenAuthed');
      }

      function openPersonnel() {
        hideMsg('staffError');
        show('screenBossPersonnel');
        loadStaff();
      }

      function loadStaff() {
        const token = getSavedToken();
        google.script.run
          .withSuccessHandler(res => {
            if (!res || !res.ok) {
              setMsg('staffError', (res && res.error) ? res.error : '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª.');
              return;
            }
            renderStaffList('staffActive', res.active || [], true);
            renderStaffList('staffInactive', res.inactive || [], false);
          })
          .withFailureHandler(err => {
            setMsg('staffError', '–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏: ' + (err && err.message ? err.message : err));
          })
          .apiGetStaff({ token });
      }

      function renderStaffList(elId, list, isActive) {
        const el = document.getElementById(elId);
        el.innerHTML = '';
        if (!list.length) {
          const li = document.createElement('li');
          li.className = 'staff-item';
          li.textContent = isActive ? '–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–µ—Å—Å–∏–π.' : '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö.';
          el.appendChild(li);
          return;
        }

        list.forEach(item => {
          const li = document.createElement('li');
          li.className = 'staff-item';
          const title = document.createElement('div');
          title.textContent = item.name || '–ë–µ–∑ –∏–º–µ–Ω–∏';
          const meta = document.createElement('div');
          const area = item.area ? `–£—á–∞—Å—Ç–æ–∫: ${item.area}` : '–£—á–∞—Å—Ç–æ–∫: ‚Äî';
          const time = isActive ? item.session_started_at : item.last_login_at;
          const timeLabel = isActive ? '–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è' : '–ü–æ—Å–ª–µ–¥–Ω–∏–π –≤—Ö–æ–¥';
          meta.className = 'staff-meta';
          meta.textContent = `${area} ¬∑ ${timeLabel}: ${formatDateTime(time)}`;
          li.appendChild(title);
          li.appendChild(meta);
          el.appendChild(li);
        });
      }

      function formatDateTime(value) {
        if (!value) return '‚Äî';
        const date = new Date(value);
        if (Number.isNaN(date.getTime())) return '‚Äî';
        const pad = num => String(num).padStart(2, '0');
        return `${pad(date.getDate())}.${pad(date.getMonth() + 1)}.${date.getFullYear()} ${pad(date.getHours())}:${pad(date.getMinutes())}`;
      }

      bootstrap();
    </script>
  </body>
</html>
