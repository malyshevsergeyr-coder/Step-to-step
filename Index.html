<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      html, body { height: 100%; }
      body { font-family: Arial, sans-serif; margin: 0; background:#f6f7f9; color: #111; }
      .wrap { max-width: 1200px; margin: 24px auto; padding: 16px; }
      .card { background:#fff; border-radius: 14px; padding: 18px; box-shadow: 0 6px 18px rgba(0,0,0,.08); }
      .card--narrow { max-width: 520px; margin: 0 auto; }
      .card--flat { padding: 0; }
      h1 { font-size: 18px; margin: 0 0 12px; }
      .muted { color:#666; font-size: 12px; margin-bottom: 12px; }
      label { display:block; font-size: 12px; color:#333; margin-top: 10px; }
      input, select, textarea { width:100%; padding: 10px 12px; font-size: 14px; border:1px solid #ddd; border-radius: 10px; outline:none; font-family: inherit; box-sizing: border-box; }
      input:focus { border-color:#999; }
      .row { display:flex; gap:10px; margin-top: 12px; flex-wrap: wrap; }
      button { flex:1; padding: 11px 12px; font-size: 14px; border:0; border-radius: 10px; cursor:pointer; }
      .primary { background:#111; color:#fff; }
      .ghost { background:#eee; }
      .pill { display:inline-block; padding: 6px 10px; border-radius: 999px; background:#eee; font-size: 12px; }
      .err { color:#b00020; font-size: 13px; margin-top: 10px; }
      .ok { color:#0a7a28; font-size: 13px; margin-top: 10px; }
      .top { display:flex; justify-content:space-between; align-items:center; margin-bottom: 10px; }
      .kv { font-size: 13px; margin-top: 8px; }
      .kv b { display:inline-block; min-width: 90px; }
      .menu { display:flex; flex-direction: column; gap: 10px; margin-top: 12px; }
      .menu button { width: 100%; text-align: left; }
      .section-title { font-size: 13px; font-weight: 600; margin: 14px 0 6px; }
      .staff-list { list-style: none; padding: 0; margin: 0; }
      .staff-item { padding: 10px 0; border-bottom: 1px solid #eee; font-size: 13px; }
      .staff-item:last-child { border-bottom: 0; }
      .staff-meta { color: #666; font-size: 12px; margin-top: 4px; }

      .app-shell { display: grid; grid-template-columns: 240px 1fr 320px; gap: 16px; min-height: 640px; }
      .sidebar { background: #fdfdfd; border: 1px solid #eee; border-radius: 14px; padding: 16px; display: flex; flex-direction: column; gap: 16px; }
      .sidebar .user-card { background: #f3f4f6; border-radius: 12px; padding: 12px; }
      .sidebar .user-card .name { font-weight: 600; font-size: 14px; }
      .sidebar .user-card .meta { color: #666; font-size: 12px; margin-top: 4px; }
      .sidebar .menu button { background: #f1f2f4; border: 1px solid transparent; }
      .sidebar .menu button.is-active { background: #111; color: #fff; }
      .content { background: #fff; border: 1px solid #eee; border-radius: 14px; padding: 16px; display: flex; flex-direction: column; gap: 12px; }
      .content-header { display: flex; align-items: center; justify-content: space-between; gap: 12px; }
      .content-header h1 { margin: 0; }
      .form-grid { display: grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap: 12px; }
      .form-grid .full { grid-column: 1 / -1; }
      .form-actions { display: flex; gap: 10px; flex-wrap: wrap; justify-content: flex-end; }
      .form-actions button { flex: 0 0 auto; }

      .chat-panel { background: #fff; border: 1px solid #eee; border-radius: 14px; padding: 0; display: flex; flex-direction: column; max-height: 640px; transition: all 0.2s ease; }
      .chat-panel.minimized { height: 54px; overflow: hidden; }
      .chat-header { padding: 12px 16px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #eee; cursor: pointer; }
      .chat-header h2 { margin: 0; font-size: 15px; }
      .chat-messages { padding: 12px 16px; overflow-y: auto; flex: 1; display: flex; flex-direction: column; gap: 10px; background: #fafafa; }
      .chat-message { background: #fff; border: 1px solid #eee; border-radius: 12px; padding: 10px 12px; max-width: 90%; }
      .chat-message.is-own { align-self: flex-end; background: #111; color: #fff; }
      .chat-message .meta { font-size: 11px; color: #666; margin-top: 6px; }
      .chat-message.is-own .meta { color: #d1d1d1; }
      .chat-message img { max-width: 100%; border-radius: 8px; margin-top: 8px; }
      .chat-input { border-top: 1px solid #eee; padding: 12px 16px; display: flex; flex-direction: column; gap: 10px; }
      .chat-input textarea { resize: vertical; min-height: 88px; }
      .chat-actions { display: flex; align-items: center; justify-content: space-between; gap: 8px; }
      .attach-btn { display: inline-flex; align-items: center; gap: 6px; background: #f1f2f4; padding: 8px 10px; border-radius: 10px; cursor: pointer; border: 1px solid #e3e4e8; font-size: 13px; }
      .attach-btn input { display: none; }
      .attach-icon { display: inline-flex; width: 18px; height: 18px; }
      .status-pill { font-size: 11px; color: #666; background: #f1f2f4; padding: 4px 8px; border-radius: 999px; }

      @media (max-width: 1100px) {
        .app-shell { grid-template-columns: 200px 1fr; }
        .chat-panel { grid-column: 1 / -1; max-height: 420px; }
      }
      @media (max-width: 900px) {
        .app-shell { grid-template-columns: 1fr; }
        .sidebar { order: 1; }
        .content { order: 2; }
        .chat-panel { order: 3; }
        .form-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); }
      }
      @media (max-width: 640px) {
        .wrap { margin: 12px auto; padding: 12px; }
        .form-grid { grid-template-columns: 1fr; }
        .chat-input textarea { min-height: 120px; }
        .content-header { flex-direction: column; align-items: flex-start; }
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <div class="card card--narrow" id="screenLogin" style="display:none;">
        <div class="top">
          <h1>üîê –í—Ö–æ–¥</h1>
          <span class="pill">–ü–∏–ª–æ—Ç</span>
        </div>
        <div class="muted">–õ–æ–≥–∏–Ω/–ø–∞—Ä–æ–ª—å —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ Google Sheets (–ø–∞—Ä–æ–ª—å ‚Äî –≤ –≤–∏–¥–µ —Ö—ç—à–∞). –°–µ—Å—Å–∏—è –∑–∞–ø–æ–º–∏–Ω–∞–µ—Ç—Å—è –≤ –±—Ä–∞—É–∑–µ—Ä–µ.</div>

        <label>–õ–æ–≥–∏–Ω</label>
        <input id="login" autocomplete="username" />

        <label>–ü–∞—Ä–æ–ª—å</label>
        <input id="password" type="password" autocomplete="current-password" />

        <div class="row">
          <button class="primary" onclick="login()">–í–æ–π—Ç–∏</button>
          <button class="ghost" onclick="clearSaved()">–°–±—Ä–æ—Å–∏—Ç—å</button>
        </div>

        <div id="msgLogin" class="err" style="display:none;"></div>
      </div>

      <div class="card card--flat" id="screenAuthed" style="display:none;">
        <div class="app-shell">
          <aside class="sidebar">
            <div class="user-card">
              <div class="name" id="uName"></div>
              <div class="meta">–†–æ–ª—å: <span id="uRole"></span></div>
              <div class="meta">–£—á–∞—Å—Ç–æ–∫: <span id="uArea"></span></div>
            </div>
            <div>
              <div class="section-title">–ú–µ–Ω—é –∑–∞—è–≤–æ–∫</div>
              <div class="menu" id="orderMenu">
                <button class="menu-btn is-active" data-order="cut-1">–ó–∞–¥–∞–Ω–∏–µ –Ω–∞ —Ä–∞—Å–∫—Ä–æ–π 1</button>
                <button class="menu-btn" data-order="cut-2">–ó–∞–¥–∞–Ω–∏–µ –Ω–∞ —Ä–∞—Å–∫—Ä–æ–π 2</button>
                <button class="menu-btn" data-order="assembly">–°–±–æ—Ä–∫–∞</button>
                <button class="menu-btn" data-order="pack">–£–ø–∞–∫–æ–≤–∫–∞</button>
              </div>
            </div>
            <button class="ghost" onclick="logout()">–í—ã–π—Ç–∏</button>
          </aside>

          <main class="content">
            <div class="content-header">
              <div>
                <h1 id="orderTitle">–ó–∞—è–≤–∫–∞: –ó–∞–¥–∞–Ω–∏–µ –Ω–∞ —Ä–∞—Å–∫—Ä–æ–π 1</h1>
                <div class="muted" id="orderSubtitle">–û–±–Ω–æ–≤–∏—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞—è–≤–∫–∏ –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è.</div>
              </div>
              <span class="status-pill" id="orderStatus">–°—Ç–∞—Ç—É—Å: –≤ —Ä–∞–±–æ—Ç–µ</span>
            </div>
            <form class="form-grid" id="orderForm" onsubmit="event.preventDefault();">
              <div>
                <label>–ù–æ–º–µ—Ä –∏–∑–¥–µ–ª–∏—è</label>
                <input id="orderProductId" placeholder="PR-0001" />
              </div>
              <div>
                <label>–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</label>
                <select id="orderDirection">
                  <option value="front">–õ–∏—Ü–æ</option>
                  <option value="back">–û–±–æ—Ä–æ—Ç</option>
                </select>
              </div>
              <div>
                <label>–ü—Ä–æ—Ü–µ—Å—Å</label>
                <select id="orderProcess">
                  <option value="cut">–†–∞—Å–∫—Ä–æ–π</option>
                  <option value="assembly">–°–±–æ—Ä–∫–∞</option>
                  <option value="pack">–£–ø–∞–∫–æ–≤–∫–∞</option>
                </select>
              </div>
              <div>
                <label>–®–∏—Ä–∏–Ω–∞ (–º–º)</label>
                <input id="orderWidth" type="number" min="0" step="1" />
              </div>
              <div>
                <label>–í—ã—Å–æ—Ç–∞ (–º–º)</label>
                <input id="orderHeight" type="number" min="0" step="1" />
              </div>
              <div>
                <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</label>
                <input id="orderQuantity" type="number" min="1" step="1" />
              </div>
              <div class="full">
                <label>–§–æ—Ä–º—É–ª–∞</label>
                <input id="orderFormula" placeholder="((—à–∏—Ä–∏–Ω–∞+–ø—Ä–∏–ø—É—Å–∫)*–∫–æ–ª-–≤–æ)" />
              </div>
              <div>
                <label>–ü–µ—á–∞—Ç—å</label>
                <select id="orderPrint">
                  <option value="yes">–î–∞</option>
                  <option value="no">–ù–µ—Ç</option>
                </select>
              </div>
              <div>
                <label>–°—Ç–∏–∫–µ—Ä</label>
                <select id="orderSticker">
                  <option value="yes">–î–∞</option>
                  <option value="no">–ù–µ—Ç</option>
                </select>
              </div>
              <div>
                <label>–†—É—á–Ω–æ–π —Ä–µ–∂–∏–º</label>
                <select id="orderManual">
                  <option value="no">–ù–µ—Ç</option>
                  <option value="yes">–î–∞</option>
                </select>
              </div>
              <div class="full">
                <label>–ü—Ä–∏–ø—É—Å–∫</label>
                <textarea id="orderAllowance" rows="3" placeholder="–î–æ–±–∞–≤—å—Ç–µ –∑–∞–º–µ—Ç–∫–∏ –ø–æ –ø—Ä–∏–ø—É—Å–∫–∞–º."></textarea>
              </div>
            </form>
            <div class="form-actions">
              <button class="ghost" onclick="resetOrderForm()">–°–±—Ä–æ—Å–∏—Ç—å</button>
              <button class="primary" onclick="saveOrder()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
          </main>

          <section class="chat-panel" id="chatPanel">
            <div class="chat-header" id="chatHeader">
              <h2>–ß–∞—Ç –∑–∞—è–≤–∫–∏</h2>
              <span class="status-pill" id="chatStatus">–û–±–Ω–æ–≤–ª–µ–Ω–æ —Ç–æ–ª—å–∫–æ —á—Ç–æ</span>
            </div>
            <div class="chat-messages" id="chatMessages"></div>
            <div class="chat-input">
              <textarea id="chatInput" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..."></textarea>
              <div class="chat-actions">
                <label class="attach-btn" title="–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–æ—Ç–æ">
                  <input type="file" id="chatFile" accept="image/*" />
                  <span class="attach-icon" aria-hidden="true">
                    <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M21.44 11.05l-8.49 8.49a5 5 0 01-7.07-7.07l9.19-9.19a3.5 3.5 0 114.95 4.95l-9.2 9.19a2 2 0 11-2.83-2.83l8.48-8.48" />
                    </svg>
                  </span>
                  <span>–°–∫—Ä–µ–ø–∫–∞</span>
                </label>
                <button class="primary" onclick="sendChatMessage()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
              </div>
              <div class="muted" id="chatHint">–ò—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ —Ç–∞–±–ª–∏—Ü–µ –∏ –¥–æ—Å—Ç—É–ø–Ω–∞ –≤—Å–µ–º —É—á–∞—Å—Ç–Ω–∏–∫–∞–º.</div>
            </div>
          </section>
        </div>
      </div>

      <div class="card card--narrow" id="screenBossMenu" style="display:none;">
        <div class="top">
          <h1>üß≠ –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é</h1>
          <button class="ghost" style="flex:0; padding:8px 10px;" onclick="logout()">–í—ã–π—Ç–∏</button>
        </div>
        <div class="kv"><b>–ù–∞—á–∞–ª—å–Ω–∏–∫:</b> <span id="bossName"></span></div>
        <div class="menu">
          <button class="primary" onclick="openPersonnel()">–ü–µ—Ä—Å–æ–Ω–∞–ª</button>
        </div>
      </div>

      <div class="card card--narrow" id="screenBossPersonnel" style="display:none;">
        <div class="top">
          <h1>üë• –ü–µ—Ä—Å–æ–Ω–∞–ª</h1>
          <button class="ghost" style="flex:0; padding:8px 10px;" onclick="show('screenBossMenu')">–ù–∞–∑–∞–¥</button>
        </div>
        <div class="muted">–°–Ω–∞—á–∞–ª–∞ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –∞–∫—Ç–∏–≤–Ω—ã–µ —Å–µ—Å—Å–∏–∏, –∑–∞—Ç–µ–º –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏.</div>
        <div id="staffError" class="err" style="display:none;"></div>
        <div class="section-title">–ê–∫—Ç–∏–≤–Ω—ã–µ</div>
        <ul class="staff-list" id="staffActive"></ul>
        <div class="section-title">–ù–µ–∞–∫—Ç–∏–≤–Ω—ã–µ</div>
        <ul class="staff-list" id="staffInactive"></ul>
      </div>
    </div>

    <script>
      const LS_TOKEN_KEY = 'pilot_session_token_v1';
      const CHAT_POLL_MS = 15000;
      const ORDER_LABELS = {
        'cut-1': '–ó–∞–¥–∞–Ω–∏–µ –Ω–∞ —Ä–∞—Å–∫—Ä–æ–π 1',
        'cut-2': '–ó–∞–¥–∞–Ω–∏–µ –Ω–∞ —Ä–∞—Å–∫—Ä–æ–π 2',
        'assembly': '–°–±–æ—Ä–∫–∞',
        'pack': '–£–ø–∞–∫–æ–≤–∫–∞'
      };
      let chatPollTimer = null;
      let currentUser = null;
      let currentOrderId = 'cut-1';
      let appReady = false;

      function setMsg(elId, text, ok=false) {
        const el = document.getElementById(elId);
        el.style.display = 'block';
        el.className = ok ? 'ok' : 'err';
        el.textContent = text;
      }
      function hideMsg(elId) {
        const el = document.getElementById(elId);
        el.style.display = 'none';
        el.textContent = '';
      }

      function show(screenId) {
        document.getElementById('screenLogin').style.display = 'none';
        document.getElementById('screenAuthed').style.display = 'none';
        document.getElementById('screenBossMenu').style.display = 'none';
        document.getElementById('screenBossPersonnel').style.display = 'none';
        document.getElementById(screenId).style.display = 'block';
      }

      function getSavedToken() {
        try { return localStorage.getItem(LS_TOKEN_KEY) || ''; } catch(e) { return ''; }
      }
      function saveToken(token) {
        try { localStorage.setItem(LS_TOKEN_KEY, token); } catch(e) {}
      }
      function clearSaved() {
        try { localStorage.removeItem(LS_TOKEN_KEY); } catch(e) {}
        setMsg('msgLogin', '–°–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–∞—è —Å–µ—Å—Å–∏—è —É–¥–∞–ª–µ–Ω–∞.', true);
      }

      function bootstrap() {
        const token = getSavedToken();
        google.script.run
          .withSuccessHandler(res => {
            if (!res || !res.ok) { show('screenLogin'); return; }
            if (res.auth && res.auth.isAuthed) {
              saveToken(res.auth.token);
              renderUser(res.auth.user);
              showAuthedScreen(res.auth.user);
              return;
            }
            show('screenLogin');
            setTimeout(() => document.getElementById('login').focus(), 50);
          })
          .withFailureHandler(err => {
            show('screenLogin');
            setMsg('msgLogin', '–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏: ' + (err && err.message ? err.message : err));
          })
          .apiBootstrap({ token });
      }

      function login() {
        hideMsg('msgLogin');
        const login = document.getElementById('login').value.trim();
        const password = document.getElementById('password').value;

        if (!login || !password) {
          setMsg('msgLogin', '–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å.');
          return;
        }

        google.script.run
          .withSuccessHandler(res => {
            if (!res || !res.ok) {
              setMsg('msgLogin', (res && res.error) ? res.error : '–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞');
              return;
            }
            saveToken(res.token);
            renderUser(res.user);
            showAuthedScreen(res.user);
          })
          .withFailureHandler(err => {
            setMsg('msgLogin', '–û—à–∏–±–∫–∞: ' + (err && err.message ? err.message : err));
          })
          .apiLogin({ login, password });
      }

      function logout() {
        const token = getSavedToken();
        try { localStorage.removeItem(LS_TOKEN_KEY); } catch(e) {}
        if (chatPollTimer) {
          clearInterval(chatPollTimer);
          chatPollTimer = null;
        }

        google.script.run
          .withSuccessHandler(() => {
            show('screenLogin');
            document.getElementById('password').value = '';
            setTimeout(() => document.getElementById('login').focus(), 50);
          })
          .withFailureHandler(() => {
            show('screenLogin');
          })
          .apiLogout({ token });
      }

      function renderUser(u) {
        document.getElementById('uName').textContent = u && u.name ? u.name : '';
        document.getElementById('uRole').textContent = u && u.role ? u.role : '';
        document.getElementById('uArea').textContent = u && u.area ? u.area : '';
      }

      function showAuthedScreen(u) {
        currentUser = u;
        const role = (u && u.role) ? String(u.role).trim() : '';
        if (role === '–ù–∞—á–∞–ª—å–Ω–∏–∫') {
          document.getElementById('bossName').textContent = u && u.name ? u.name : '';
          show('screenBossMenu');
          return;
        }
        show('screenAuthed');
        initUserApp();
      }

      function initUserApp() {
        if (appReady) return;
        appReady = true;
        initOrderMenu();
        setActiveOrder(currentOrderId);
        initChat();
        document.addEventListener('click', handleOutsideChatClick);
      }

      function initOrderMenu() {
        const buttons = Array.from(document.querySelectorAll('#orderMenu .menu-btn'));
        buttons.forEach(btn => {
          btn.addEventListener('click', () => {
            setActiveOrder(btn.dataset.order || '');
          });
        });
      }

      function setActiveOrder(orderId) {
        if (!orderId) return;
        currentOrderId = orderId;
        const buttons = Array.from(document.querySelectorAll('#orderMenu .menu-btn'));
        buttons.forEach(btn => {
          btn.classList.toggle('is-active', btn.dataset.order === orderId);
        });
        const label = ORDER_LABELS[orderId] || '–ó–∞—è–≤–∫–∞';
        document.getElementById('orderTitle').textContent = `–ó–∞—è–≤–∫–∞: ${label}`;
        document.getElementById('orderSubtitle').textContent = `–†–∞–±–æ—Ç–∞–µ–º —Å –∑–∞—è–≤–∫–æ–π ¬´${label}¬ª.`;
        loadChatMessages();
      }

      function resetOrderForm() {
        document.getElementById('orderForm').reset();
        document.getElementById('orderStatus').textContent = '–°—Ç–∞—Ç—É—Å: —á–µ—Ä–Ω–æ–≤–∏–∫';
      }

      function saveOrder() {
        document.getElementById('orderStatus').textContent = '–°—Ç–∞—Ç—É—Å: —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ';
      }

      function initChat() {
        const header = document.getElementById('chatHeader');
        header.addEventListener('click', () => {
          document.getElementById('chatPanel').classList.toggle('minimized');
        });
        loadChatMessages();
        if (chatPollTimer) clearInterval(chatPollTimer);
        chatPollTimer = setInterval(loadChatMessages, CHAT_POLL_MS);
      }

      function handleOutsideChatClick(event) {
        const chatPanel = document.getElementById('chatPanel');
        if (!chatPanel) return;
        if (chatPanel.contains(event.target)) return;
        chatPanel.classList.add('minimized');
      }

      function setChatStatus(text) {
        const status = document.getElementById('chatStatus');
        status.textContent = text;
      }

      function sendChatMessage() {
        const token = getSavedToken();
        const input = document.getElementById('chatInput');
        const fileInput = document.getElementById('chatFile');
        const text = input.value.trim();
        const file = fileInput.files && fileInput.files[0] ? fileInput.files[0] : null;

        if (!text && !file) {
          setChatStatus('–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–ª–∏ –¥–æ–±–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ.');
          return;
        }

        setChatStatus('–û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è...');
        const payload = { token, chat_id: currentOrderId, text };

        if (file) {
          const reader = new FileReader();
          reader.onload = () => {
            const dataUrl = reader.result || '';
            payload.attachment = {
              name: file.name,
              type: file.type,
              data: String(dataUrl)
            };
            submitChatPayload(payload, input, fileInput);
          };
          reader.onerror = () => {
            setChatStatus('–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Ñ–∞–π–ª.');
          };
          reader.readAsDataURL(file);
          return;
        }

        submitChatPayload(payload, input, fileInput);
      }

      function submitChatPayload(payload, input, fileInput) {
        google.script.run
          .withSuccessHandler(res => {
            if (!res || !res.ok) {
              setChatStatus((res && res.error) ? res.error : '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ.');
              return;
            }
            input.value = '';
            fileInput.value = '';
            renderChatMessages(res.messages || []);
            setChatStatus('–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ');
          })
          .withFailureHandler(err => {
            setChatStatus('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ' + (err && err.message ? err.message : err));
          })
          .apiSendChatMessage(payload);
      }

      function loadChatMessages() {
        const token = getSavedToken();
        google.script.run
          .withSuccessHandler(res => {
            if (!res || !res.ok) {
              setChatStatus((res && res.error) ? res.error : '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —á–∞—Ç.');
              return;
            }
            renderChatMessages(res.messages || []);
            setChatStatus('–û–±–Ω–æ–≤–ª–µ–Ω–æ ' + formatDateTime(res.updated_at));
          })
          .withFailureHandler(err => {
            setChatStatus('–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏: ' + (err && err.message ? err.message : err));
          })
          .apiGetChatMessages({ token, chat_id: currentOrderId });
      }

      function renderChatMessages(messages) {
        const list = document.getElementById('chatMessages');
        list.innerHTML = '';
        if (!messages.length) {
          const empty = document.createElement('div');
          empty.className = 'muted';
          empty.textContent = '–°–æ–æ–±—â–µ–Ω–∏–π –ø–æ–∫–∞ –Ω–µ—Ç.';
          list.appendChild(empty);
          return;
        }
        messages.forEach(message => {
          const wrapper = document.createElement('div');
          const isOwn = currentUser && message.user_id === currentUser.user_id;
          wrapper.className = 'chat-message' + (isOwn ? ' is-own' : '');

          if (message.text) {
            const text = document.createElement('div');
            text.textContent = message.text;
            wrapper.appendChild(text);
          }

          if (message.attachment_url) {
            const img = document.createElement('img');
            img.src = message.attachment_url;
            img.alt = '–í–ª–æ–∂–µ–Ω–∏–µ';
            wrapper.appendChild(img);
          }

          const meta = document.createElement('div');
          meta.className = 'meta';
          const author = message.user_name || '–ë–µ–∑ –∏–º–µ–Ω–∏';
          const time = formatDateTime(message.created_at);
          let status = '';
          if (isOwn) {
            status = message.read_at ? ' ¬∑ –ø—Ä–æ—á–∏—Ç–∞–Ω–æ' : (message.delivered_at ? ' ¬∑ –¥–æ—Å—Ç–∞–≤–ª–µ–Ω–æ' : '');
          }
          meta.textContent = `${author} ¬∑ ${time}${status}`;
          wrapper.appendChild(meta);
          list.appendChild(wrapper);
        });
        list.scrollTop = list.scrollHeight;
      }

      function openPersonnel() {
        hideMsg('staffError');
        show('screenBossPersonnel');
        loadStaff();
      }

      function loadStaff() {
        const token = getSavedToken();
        google.script.run
          .withSuccessHandler(res => {
            if (!res || !res.ok) {
              setMsg('staffError', (res && res.error) ? res.error : '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª.');
              return;
            }
            renderStaffList('staffActive', res.active || [], true);
            renderStaffList('staffInactive', res.inactive || [], false);
          })
          .withFailureHandler(err => {
            setMsg('staffError', '–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏: ' + (err && err.message ? err.message : err));
          })
          .apiGetStaff({ token });
      }

      function renderStaffList(elId, list, isActive) {
        const el = document.getElementById(elId);
        el.innerHTML = '';
        if (!list.length) {
          const li = document.createElement('li');
          li.className = 'staff-item';
          li.textContent = isActive ? '–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–µ—Å—Å–∏–π.' : '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö.';
          el.appendChild(li);
          return;
        }

        list.forEach(item => {
          const li = document.createElement('li');
          li.className = 'staff-item';
          const title = document.createElement('div');
          title.textContent = item.name || '–ë–µ–∑ –∏–º–µ–Ω–∏';
          const meta = document.createElement('div');
          const area = item.area ? `–£—á–∞—Å—Ç–æ–∫: ${item.area}` : '–£—á–∞—Å—Ç–æ–∫: ‚Äî';
          const time = isActive ? item.session_started_at : item.last_login_at;
          const timeLabel = isActive ? '–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è' : '–ü–æ—Å–ª–µ–¥–Ω–∏–π –≤—Ö–æ–¥';
          meta.className = 'staff-meta';
          meta.textContent = `${area} ¬∑ ${timeLabel}: ${formatDateTime(time)}`;
          li.appendChild(title);
          li.appendChild(meta);
          el.appendChild(li);
        });
      }

      function formatDateTime(value) {
        if (!value) return '‚Äî';
        const date = new Date(value);
        if (Number.isNaN(date.getTime())) return '‚Äî';
        const pad = num => String(num).padStart(2, '0');
        return `${pad(date.getDate())}.${pad(date.getMonth() + 1)}.${date.getFullYear()} ${pad(date.getHours())}:${pad(date.getMinutes())}`;
      }

      bootstrap();
    </script>
  </body>
</html>
